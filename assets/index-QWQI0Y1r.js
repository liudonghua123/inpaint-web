import{r as h,j as i,u as De,V as Pe,E as ze,D as Ae,a as Ue,A as Oe,I as He,R as Be}from"./react-runtime-PknvKX-t.js";import{c as v}from"./opencv-runtime-EkUFfWHa.js";import{o as E}from"./onnxruntime-runtime-LwaksCuF.js";import{l as Ee}from"./vendor--CXyP0cY.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))r(o);new MutationObserver(o=>{for(const c of o)if(c.type==="childList")for(const a of c.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&r(a)}).observe(document,{childList:!0,subtree:!0});function n(o){const c={};return o.integrity&&(c.integrity=o.integrity),o.referrerPolicy&&(c.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?c.credentials="include":o.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function r(o){if(o.ep)return;o.ep=!0;const c=n(o);fetch(o.href,c)}})();function K(e){const{children:t,className:n,icon:r,primary:o,style:c,onClick:a,onDown:d,onUp:s,onEnter:m,onLeave:f}=e,[l,p]=h.useState(!1);let w="";return o&&(w="bg-primary hover:bg-black hover:text-white"),l&&(w="bg-black text-white"),!o&&!l&&(w="hover:bg-primary"),i.jsxs("div",{role:"button",onKeyDown:()=>{d==null||d()},onClick:a,onPointerDown:()=>{p(!0),d==null||d()},onPointerUp:()=>{p(!1),s==null||s()},onPointerEnter:()=>{m==null||m()},onPointerLeave:()=>{f==null||f()},tabIndex:-1,className:["inline-flex space-x-3 py-3 px-5 rounded-md cursor-pointer",w,n].join(" "),style:c,children:[r,i.jsx("span",{className:"whitespace-nowrap select-none",children:t})]})}let ye;const Ge="en";let R=()=>Ge;const Re=e=>{typeof e=="function"?R=e:R=()=>e,ye!==void 0&&ye(R())},Fe=e=>{ye=e},We=()=>"Click or drag here",Ve=()=>"Try it:",Ze=()=>"Feedback",Ke=()=>"Start new",Xe=()=>"Brush Size",Ye=()=>"Original",qe=()=>"4x-upscaling",Je=()=>"Download",Qe=()=>"Undo",et=()=>"Need to download a 30MB model file, please wait patiently...",tt=()=>"Need to download a 70MB model file, please wait patiently...",nt=()=>"点击 或者 拖拽到这里",st=()=>"试一试:",ot=()=>"反馈",rt=()=>"开始新的",at=()=>"刷子大小",it=()=>"原图",ct=()=>"4 倍放大",lt=()=>"下载",ut=()=>"撤销",dt=()=>"需要下载一次30MB大小模型文件,耐心等待。。。",mt=()=>"需要下载一次70MB大小模型文件,耐心等待。。。",ft=(e={},t={})=>{const n=t.languageTag??R();if(n==="en")return We();if(n==="zh")return nt()},ht=(e={},t={})=>{const n=t.languageTag??R();if(n==="en")return Ve();if(n==="zh")return st()},gt=(e={},t={})=>{const n=t.languageTag??R();if(n==="en")return Ze();if(n==="zh")return ot()},pt=(e={},t={})=>{const n=t.languageTag??R();if(n==="en")return Ke();if(n==="zh")return rt()},wt=(e={},t={})=>{const n=t.languageTag??R();if(n==="en")return Xe();if(n==="zh")return at()},xt=(e={},t={})=>{const n=t.languageTag??R();if(n==="en")return Ye();if(n==="zh")return it()},vt=(e={},t={})=>{const n=t.languageTag??R();if(n==="en")return qe();if(n==="zh")return ct()},yt=(e={},t={})=>{const n=t.languageTag??R();if(n==="en")return Je();if(n==="zh")return lt()},bt=(e={},t={})=>{const n=t.languageTag??R();if(n==="en")return Qe();if(n==="zh")return ut()},jt=(e={},t={})=>{const n=t.languageTag??R();if(n==="en")return et();if(n==="zh")return dt()},Et=(e={},t={})=>{const n=t.languageTag??R();if(n==="en")return tt();if(n==="zh")return mt()};function It(e){const{onSelection:t}=e,[n,r]=h.useState(!1),[o]=h.useState(`file-upload-${Math.random().toString()}`);function c(l){if(!(!l||!l.type.match("image.*")))try{if(l.size>10*1024*1024)throw new Error("file too large");t(l)}catch(w){alert(`error: ${w.message}`)}}async function a(l){return new Promise(p=>{l.file(w=>p(w))})}async function d(l){const p=[],w=[];for(let y=0;y<l.length;y+=1)w.push(l[y].webkitGetAsEntry());for(;w.length>0;){const y=w.shift();if(y!=null&&y.isFile){const P=await a(y);p.push(P)}else y!=null&&y.isDirectory&&w.push(...await s(y.createReader()))}return p}async function s(l){const p=[];let w=await m(l);for(;w.length>0;)p.push(...w),w=await m(l);return p}async function m(l){return new Promise((p,w)=>{l.readEntries(p,w)})}async function f(l){l.preventDefault();const p=await d(l.dataTransfer.items);r(!1),c(p[0])}return i.jsx("label",{htmlFor:o,className:"block w-full h-full group relative cursor-pointer rounded-md font-medium focus-within:outline-none",children:i.jsxs("div",{className:["w-full h-full flex items-center justify-center px-6 pt-5 pb-6 text-xl","border-4 border-dashed rounded-md","hover:border-black hover:bg-primary","text-center",n?"border-black bg-primary":"bg-gray-100 border-gray-300"].join(" "),onDrop:f,onDragOver:l=>{l.stopPropagation(),l.preventDefault(),r(!0)},onDragLeave:()=>r(!1),children:[i.jsx("input",{id:o,name:o,type:"file",className:"sr-only",onChange:l=>{var w;const p=(w=l.currentTarget.files)==null?void 0:w[0];p&&c(p)},accept:"image/png, image/jpeg, image/webp"}),i.jsx("p",{children:ft()})]})})}function be(e){const{children:t}=e;return i.jsx("div",{className:["absolute w-full h-full flex justify-center items-center","bg-white bg-opacity-40 backdrop-filter backdrop-blur-md"].join(" "),children:i.jsx("div",{className:"bg-primary p-16 max-w-4xl",children:t})})}var Z={BASE_URL:"/inpaint-web/",MODE:"production",DEV:!1,PROD:!0,SSR:!1};Ee.config({name:"modelCache"});async function $e(e,t){await Ee.setItem(le(e).name,t)}function le(e){if(console.info("import.meta.env.BASE_URL: /inpaint-web/"),e==="inpaint")return[{name:"model",backupUrl:`https://${Z.VITE_HUGGINGFACE_MIRROR?Z.VITE_HUGGINGFACE_MIRROR:"huggingface.co"}/lxfater/inpaint-web/resolve/main/migan.onnx`,url:"/inpaint-web/models/lxfater/inpaint-web/migan.onnx"},{name:"model-perf",backupUrl:`https://${Z.VITE_HUGGINGFACE_MIRROR?Z.VITE_HUGGINGFACE_MIRROR:"huggingface.co"}/andraniksargsyan/migan/resolve/main/migan.onnx`,url:"/inpaint-web/models/andraniksargsyan/migan/migan.onnx"},{name:"migan-pipeline-v2",backupUrl:`https://${Z.VITE_HUGGINGFACE_MIRROR?Z.VITE_HUGGINGFACE_MIRROR:"huggingface.co"}/andraniksargsyan/migan/resolve/main/migan_pipeline_v2.onnx`,url:"/inpaint-web/models/andraniksargsyan/migan/migan_pipeline_v2.onnx"}][2];if(e==="superResolution")return[{name:"realesrgan-x4",backupUrl:`https://${Z.VITE_HUGGINGFACE_MIRROR?Z.VITE_HUGGINGFACE_MIRROR:"huggingface.co"}/lxfater/inpaint-web/resolve/main/realesrgan-x4.onnx`,url:"/inpaint-web/models/lxfater/inpaint-web/realesrgan-x4.onnx"}][0];throw new Error("wrong modelType")}async function ke(e){return await Ee.getItem(le(e).name)}async function Ie(e){const t=await ke(e);return t!=null}async function Ne(e){if(await Ie(e))return ke(e);const t=le(e),r=await(await fetch(t.url)).arrayBuffer();return await $e(e,r),r}async function Se(e,t){if(await Ie(e))return;async function n(o){console.log("start download from",o),t(0);const c=await fetch(o),a=c.headers.get("content-length"),d=c.body.getReader(),s=[];let m=0;for(;;){const{done:p,value:w}=await d.read();if(p)break;m+=(w==null?void 0:w.length)||0,w&&s.push(w),t(m/Number(a)*100)}const f=new Uint8Array(m);let l=0;for(const p of s)f.set(p,l),l+=p.length;await $e(e,f),t(100)}const r=le(e);try{await n(r.url)}catch(o){if(r.backupUrl)try{await n(r.backupUrl)}catch(c){alert(`Failed to download the backup model: ${c}`)}alert(`Failed to download the model, network problem: ${o}`)}}const Lt=()=>typeof WebAssembly=="object"&&typeof WebAssembly.instantiate=="function",Rt=()=>(async e=>{try{return typeof MessageChannel<"u"&&new MessageChannel().port1.postMessage(new SharedArrayBuffer(1)),WebAssembly.validate(e)}catch{return!1}})(new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,2,1,0,5,4,1,3,1,1,10,11,1,9,0,65,0,254,16,2,0,26,11])),Ct=async()=>WebAssembly.validate(new Uint8Array([0,97,115,109,1,0,0,0,1,5,1,96,0,1,123,3,2,1,0,10,10,1,8,0,65,0,253,15,253,98,11])),Me=async()=>({webgpu:!1,wasm:Lt(),simd:await Ct(),threads:await Rt()});function Ce(e){return new Promise((t,n)=>{const r=new Image;r.crossOrigin="Anonymous",r.onload=()=>t(r),r.onerror=()=>n(new Error(`Failed to load image from ${e}`)),r.src=e})}function _t(e){const t=new v.MatVector;v.split(e,t);const n=t.size(),r=e.rows,o=e.cols,c=new Uint8Array(n*r*o);for(let a=0;a<n;a++){const d=t.get(a).data;for(let s=0;s<r;s++)for(let m=0;m<o;m++)c[a*r*o+s*o+m]=d[s*o+m]}return t.delete(),c}function Tt(e){const t=new v.MatVector;v.split(e,t);const n=1,r=e.rows,o=e.cols,c=new Uint8Array(n*r*o);for(let a=0;a<n;a++){const d=t.get(0).data;for(let s=0;s<r;s++)for(let m=0;m<o;m++)c[a*r*o+s*o+m]=(d[s*o+m]!==255)*255}return t.delete(),c}function $t(e,t){return new Promise((n,r)=>{try{const o=v.imread(e),c=new v.Mat;v.cvtColor(o,c,v.COLOR_RGBA2RGB),t&&v.imshow(t,c),n(_t(c)),o.delete(),c.delete()}catch(o){r(o)}})}function kt(e,t){return new Promise((n,r)=>{try{const o=v.imread(e),c=new v.Mat;v.cvtColor(o,c,v.COLOR_BGR2GRAY),t&&v.imshow(t,c),n(Tt(c)),o.delete()}catch(o){r(o)}})}function Nt(e,t,n){const r=[],o=t*n;for(let c=0;c<n;c++)for(let a=0;a<t;a++){for(let d=0;d<3;d++){const s=d*o+c*t+a,m=e[s];let f=m;m>255?f=255:m<0&&(f=0),r.push(f)}r.push(255)}return r}function St(e){const t=document.createElement("canvas");return t.width=e.width,t.height=e.height,t.getContext("2d").putImageData(e,0,0),t.toDataURL()}function Mt(e){e.webgpu?E.env.wasm.numThreads=1:(e.threads&&(E.env.wasm.numThreads=navigator.hardwareConcurrency??4),e.simd&&(E.env.wasm.simd=!0),E.env.wasm.proxy=!0),E.env.wasm.wasmPaths=`${window.location.protocol}//${window.location.host}//inpaint-web/`,console.log("capabilities",e),console.log("env",E.env.wasm)}const Dt=(e,t,n)=>new Promise((r,o)=>{const c=document.createElement("canvas");c.width=t,c.height=n;const a=c.getContext("2d");if(!a){o(new Error("Unable to get canvas context"));return}a.drawImage(e,0,0,t,n);const d=c.toDataURL(),s=new Image;s.onload=()=>r(s),s.onerror=()=>o(new Error("Failed to load resized image")),s.src=d});let J=null;async function Pt(e,t){if(console.time("sessionCreate"),!J){const y=await Me();Mt(y);const P=await Ne("inpaint");J=await E.InferenceSession.create(P,{executionProviders:[y.webgpu?"webgpu":"wasm"]})}console.timeEnd("sessionCreate"),console.time("preProcess");const[n,r]=await Promise.all([e instanceof HTMLImageElement?e:Ce(URL.createObjectURL(e)),Ce(t)]),[o,c]=await Promise.all([$t(n),kt(await Dt(r,n.width,n.height))]),a=new E.Tensor("uint8",o,[1,3,n.height,n.width]),d=new E.Tensor("uint8",c,[1,1,n.height,n.width]),s={[J.inputNames[0]]:a,[J.inputNames[1]]:d};console.timeEnd("preProcess"),console.time("run");const m=await J.run(s);console.timeEnd("run"),console.time("postProcess");const f=m[J.outputNames[0]],l=Nt(f.data,n.width,n.height),p=new ImageData(new Uint8ClampedArray(l),n.width,n.height);console.log(p,"imageData");const w=St(p);return console.timeEnd("postProcess"),w}function zt(e){return new Promise((t,n)=>{const r=new Image;r.crossOrigin="Anonymous",r.onload=()=>t(r),r.onerror=()=>n(new Error(`Failed to load image from ${e}`)),r.src=e})}function At(e){const t=new v.MatVector;v.split(e,t);const n=t.size(),r=e.rows,o=e.cols,c=new Float32Array(n*r*o);for(let a=0;a<n;a++){const d=t.get(a).data;for(let s=0;s<r;s++)for(let m=0;m<o;m++)c[a*r*o+s*o+m]=d[s*o+m]/255}return t.delete(),c}async function Ut(e,t,n){const r=e.dims,o=r[3],c=r[2],a=0,d=o*c,s=o*c*2,m=[r[0],r[1],r[2]*4,r[3]*4],f=new E.Tensor("float32",new Float32Array(m[0]*m[1]*m[2]*m[3]),m),l=m[3],p=m[2],w=0,y=l*p,P=l*p*2,I=64,N=6,x=I-N*2,re=Math.ceil(r[3]/x),Q=Math.ceil(r[2]/x),{data:V}=e;console.log(e);const ee=re*Q;let U=0;for(let X=0;X<re;X++)for(let S=0;S<Q;S++){const ue=Date.now(),te=Math.min(x,o-X*x),ne=Math.min(x,c-S*x);console.log(`tileW: ${te} tileH: ${ne}`);const ae=0,de=I*I,ie=I*I*2,O=new Float32Array(I*I*3);for(let T=-N;T<x+N;T++)for(let k=-N;k<x+N;k++){let H=X*x+T;H<0?H=0:H>=o&&(H=o-1);let B=S*x+k;B<0?B=0:B>=c&&(B=c-1);const G=H+B*o,F=T+N,W=k+N;O[F+W*I+ae]=V[G+a],O[F+W*I+de]=V[G+d],O[F+W*I+ie]=V[G+s]}const Y=new E.Tensor("float32",O,[1,3,I,I]),M={output:(await t.run({"input.1":Y}))[1895]};console.log(`pre dims:${M.output.dims}`);const se=te*4,fe=ne*4,z=I*4,ce=x*4,he=0,ge=z*z,A=z*z*2;for(let T=0;T<se;T++)for(let k=0;k<fe;k++){const H=X*ce+T,B=S*ce+k,G=H+B*l,F=T+N*4,W=k+N*4;f.data[G+w]=M.output.data[F+W*z+he],f.data[G+y]=M.output.data[F+W*z+ge],f.data[G+P]=M.output.data[F+W*z+A]}U++;const oe=Date.now()-ue,pe=(ee-U)*oe;console.log(`tile ${U} of ${ee} took ${oe} ms, remaining time: ${pe} ms`),n(Math.round(100*(U/ee)))}return console.log(`output dims:${f.dims}`),f}function Ot(e,t){return new Promise((n,r)=>{try{const o=v.imread(e),c=new v.Mat;v.cvtColor(o,c,v.COLOR_RGBA2RGB),t&&v.imshow(t,c),n(At(c)),o.delete(),c.delete()}catch(o){r(o)}})}function Ht(e){e.webgpu?E.env.wasm.numThreads=1:(e.threads&&(E.env.wasm.numThreads=navigator.hardwareConcurrency??4),e.simd&&(E.env.wasm.simd=!0),E.env.wasm.proxy=!0),console.log("env",E.env.wasm)}function Bt(e,t,n){const r=[],o=t*n;for(let c=0;c<n;c++)for(let a=0;a<t;a++){for(let d=0;d<3;d++){const s=d*o+c*t+a,m=e[s];let f=m;m>1?f=1:m<0&&(f=0),r.push(f*255)}r.push(255)}return r}function Gt(e){const t=document.createElement("canvas");return t.width=e.width,t.height=e.height,t.getContext("2d").putImageData(e,0,0),t.toDataURL()}let ve=null;async function Ft(e,t){if(console.time("sessionCreate"),!ve){const f=await Me();Ht(f);const l=await Ne("superResolution");ve=await E.InferenceSession.create(l,{executionProviders:[f.webgpu?"webgpu":"wasm"]})}console.timeEnd("sessionCreate");const n=e instanceof HTMLImageElement?e:await zt(URL.createObjectURL(e)),r=await Ot(n),o=new E.Tensor("float32",r,[1,3,n.height,n.width]),c=await Ut(o,ve,t);console.time("postProcess");const d=Bt(c.data,n.width*4,n.height*4),s=new ImageData(new Uint8ClampedArray(d),n.width*4,n.height*4);console.log(s,"imageData");const m=Gt(s);return console.timeEnd("postProcess"),m}function Wt(e){const{value:t,label:n,min:r,max:o,onChange:c,onStart:a}=e,d=((o||100)-(r||0))/100;return i.jsxs("div",{className:"inline-flex items-center space-x-4 text-black",children:[i.jsx("span",{children:n}),i.jsx("input",{className:["appearance-none rounded-lg h-4","bg-primary"].join(" "),type:"range",step:d,min:r,max:o,value:t,onPointerDown:a,onChange:s=>{s.preventDefault(),s.stopPropagation(),c(parseInt(s.currentTarget.value,10))}})]})}function Vt(e){const t=e.split(",")[0].split(":")[1].split(";")[0],n=atob(e.split(",")[1]),r=[];for(let o=0;o<n.length;o+=1)r.push(n.charCodeAt(o));return new Blob([new Uint8Array(r)],{type:t})}function Zt(e,t){const n=document.createElement("a");n.href=e,n.download=t,n.dispatchEvent(new MouseEvent("click",{bubbles:!0,cancelable:!0,view:window})),setTimeout(()=>{n.remove()},100)}function _e(e,t){return new Promise((n,r)=>{const o=e.src,c=e;c.onload=n,c.onerror=a=>{c.src=o,r(a)},c.src=t})}function Kt(e){const[t,n]=h.useState(new Image),[r,o]=h.useState(!1),c=h.useCallback((a,d)=>{const s=document.createElement("canvas"),m=s.getContext("2d");s.width=a,s.height=d,m.drawImage(t,0,0,a,d);const f=new Image;f.src=s.toDataURL(),n(f)},[t]);return h.useEffect(()=>{const a=new Image;return a.onload=()=>{o(!0)},a.src=URL.createObjectURL(e),n(a),()=>{a.onload=null}},[e]),[t,r,c]}function Xt(e,t){const n=new FileReader,r=new Image,o=document.createElement("canvas"),c=()=>{var p;let{width:a,height:d}=r;if(a>d?a>t&&(d*=t/a,a=t):d>t&&(a*=t/d,d=t),a===r.width&&d===r.height)return{file:e,resized:!1};if(o.width=a,o.height=d,!o.getContext("2d"))throw new Error("could not get context");(p=o.getContext("2d"))==null||p.drawImage(r,0,0,a,d);const m=o.toDataURL("image/jpeg"),f=Vt(m);return{file:new File([f],e.name,{type:e.type}),resized:!0,originalWidth:r.width,originalHeight:r.height}};return new Promise((a,d)=>{if(!e.type.match(/image.*/)){d(new Error("Not an image"));return}n.onload=s=>{r.onload=()=>a(c()),r.src=s.target.result},n.readAsDataURL(e)})}function je({percent:e}){return i.jsxs("div",{className:"w-full flex items-center",children:[i.jsx("div",{className:"relative flex-1 bg-black/20 h-2 mr-4",children:i.jsx("div",{className:"absolute left-0 top-0 h-full bg-black duration-100",style:{width:`${e}%`}})}),i.jsxs("span",{className:"w-20 text-right",children:[e.toFixed(2),"%"]})]})}function Te(e,t,n="rgba(255, 0, 0, 0.5)"){e.strokeStyle=n,e.lineCap="round",e.lineJoin="round",t.forEach(r=>{!(r!=null&&r.pts.length)||!r.size||(e.lineWidth=r.size,e.beginPath(),e.moveTo(r.pts[0].x,r.pts[0].y),r.pts.forEach(o=>e.lineTo(o.x,o.y)),e.stroke())})}const Yt=2e3;function qt(e){const{file:t}=e,[n,r]=h.useState(40),[o,c]=Kt(t),[a,d]=h.useState([]),[s,m]=h.useState(),[f]=h.useState(()=>document.createElement("canvas")),[l,p]=h.useState([{pts:[],src:""}]),w=h.useRef(null),[y,P]=h.useState(!1),[I,N]=h.useState(0),[x,re]=h.useState(!1),[Q,V]=h.useState(!1),[ee,U]=h.useState(0),X=h.useRef(null),[S,ue]=h.useState(),[te,ne]=h.useState(!1),[ae,de]=h.useState(),[ie,O]=h.useState(0),Y=h.useRef(null),me=h.useRef(!1),M=h.useMemo(()=>n,[n]),se=h.useRef(null),[fe,z]=h.useState(!0),[ce,he]=h.useState(0),ge=De(),A=h.useCallback((u=-1)=>{if(!s)return;s.clearRect(0,0,s.canvas.width,s.canvas.height);const g=a[u===-1?a.length-1:u]??o,{canvas:L}=s,C=se.current.offsetWidth,$=se.current.offsetHeight,q=g.width/g.height,D=C/$;let b,_;D>q?(_=$,b=g.width*($/g.height)):(b=C,_=g.height*(C/g.width)),L.width=b,L.height=_,g!=null&&g.src?s.drawImage(g,0,0,L.width,L.height):s.drawImage(o,0,0,L.width,L.height);const j=l[l.length-1];Te(s,[j])},[s,l,o,a]),oe=h.useCallback(()=>{if(!(s!=null&&s.canvas.width)||!(s!=null&&s.canvas.height))throw new Error("canvas has invalid size");f.width=s==null?void 0:s.canvas.width,f.height=s==null?void 0:s.canvas.height;const u=f.getContext("2d");if(!u)throw new Error("could not retrieve mask canvas");const g=l.slice(-1)[0];g&&Te(u,[g],"white")},[s==null?void 0:s.canvas.height,s==null?void 0:s.canvas.width,l,f]);h.useEffect(()=>{s!=null&&s.canvas&&c&&A()},[s==null?void 0:s.canvas,A,o,c,ge]),h.useEffect(()=>{const u=s==null?void 0:s.canvas;if(!u)return;const g=b=>{if(w.current){const _=b.pageX-M/2,j=b.pageY-M/2;w.current.style.transform=`translate3d(${_}px, ${j}px, 0)`}},L=(b,_)=>{l[l.length-1].pts.push({x:b,y:_}),A()},C=b=>{const _=b.offsetX-u.offsetLeft,j=b.offsetY-u.offsetTop;L(_,j)},$=async()=>{var _;if(!o.src||x||((_=l.slice(-1)[0])==null?void 0:_.pts.length)===0)return;const b=F();u.removeEventListener("mousemove",C),u.removeEventListener("mouseup",$),oe();try{const j=Date.now();console.log("inpaint_start");const we=a.slice(-1)[0]??t,Le=await Pt(we,f.toDataURL());if(!Le)throw new Error("empty response");const xe=new Image;xe.dataset.id=Date.now().toString(),await _e(xe,Le),a.push(xe),l.push({pts:[],src:""}),d([...a]),p([...l]),console.log("inpaint_processed",{duration:Date.now()-j})}catch(j){console.log("inpaint_failed",{error:j}),alert(j.message?j.message:j.toString())}if(Y.current){const{scrollWidth:j,clientWidth:we}=Y.current;j>we&&Y.current.scrollTo(j,0)}b.close(),A()};u.addEventListener("mousemove",g);const q=b=>{b.preventDefault(),b.stopPropagation();const _=l[l.length-1],j=u.getBoundingClientRect();_.pts.push({x:b.touches[0].clientX-j.x,y:b.touches[0].clientY-j.y}),A()},D=()=>{if(!o.src||x)return;const b=l[l.length-1];b.size=n,u.addEventListener("mousemove",C),u.addEventListener("mouseup",$)};return u.addEventListener("touchstart",D),u.addEventListener("touchmove",q),u.addEventListener("touchend",$),u.onmouseenter=()=>{window.clearTimeout(I),P(!x)},u.onmouseleave=()=>P(!1),u.onmousedown=D,()=>{u.removeEventListener("mousemove",C),u.removeEventListener("mousemove",g),u.removeEventListener("mouseup",$),u.removeEventListener("touchstart",D),u.removeEventListener("touchmove",q),u.removeEventListener("touchend",$),u.onmouseenter=null,u.onmouseleave=null,u.onmousedown=null}},[n,s,t,A,l,oe,f,o.src,a,x,I]),h.useEffect(()=>{if(!S||!ae)return;const u=C=>{if(C.preventDefault(),C.stopPropagation(),s!=null&&s.canvas){const{width:$}=s==null?void 0:s.canvas,q=s==null?void 0:s.canvas.getBoundingClientRect(),D=C.pageX-q.left;D<=$&&D>=0?O(D):D<0?O(0):D>$&&O($)}},g=()=>{window.addEventListener("mousemove",u),ne(!0)},L=()=>{window.removeEventListener("mousemove",u),ne(!1)};return S.addEventListener("mousedown",g),window.addEventListener("mouseup",L),()=>{S.removeEventListener("mousedown",g),window.removeEventListener("mouseup",L)}},[S,s]);function pe(){const u=a.at(-1)??o;Zt(u.currentSrc,"IMG")}const T=h.useCallback(async()=>{const u=l;u.pop(),u.pop(),p([...u,{pts:[],src:""}]);const g=a;g.pop(),d([...g])},[l,a]);h.useEffect(()=>{const u=g=>{if(!a.length)return;(g.metaKey||g.ctrlKey)&&g.key==="z"&&(g.preventDefault(),T())};return window.addEventListener("keydown",u),()=>{window.removeEventListener("keydown",u)}},[a,T]);const k=h.useCallback(u=>{l.splice(u+1),p([...l,{pts:[],src:""}]),a.splice(u+1),d([...a])},[a,l]),H=h.useMemo(()=>a.map((u,g)=>i.jsxs("div",{style:{position:"relative",display:"inline-block",flexShrink:0},children:[i.jsx("img",{src:u.src,alt:"render",className:"rounded-sm",style:{height:"90px"}}),i.jsx(K,{className:"hover:opacity-100 opacity-0 cursor-pointer rounded-sm",style:{position:"absolute",top:"0",left:"0",width:"100%",height:"100%",backgroundColor:"rgba(0, 0, 0, 0.5)",display:"flex",alignItems:"center",justifyContent:"center"},onClick:()=>k(g),onEnter:()=>A(g),onLeave:A,children:i.jsxs("div",{style:{color:"#fff",fontSize:"12px",textAlign:"center"},children:["回到这",i.jsx("br",{}),"Back here"]})})]},u.dataset.id)),[a,k]),B=()=>{P(!0)},G=u=>{if(me.current||(me.current=!0),w.current){const g=document.documentElement.clientWidth/2-M/2,L=document.documentElement.clientHeight/2-M/2;w.current.style.transform=`translate3d(${g}px, ${L}px, 0)`}r(u),window.clearTimeout(I),N(window.setTimeout(()=>{P(!1)},Yt))},F=h.useCallback(()=>{V(!0),U(0);const u=window.setInterval(()=>{U(g=>g<90?g+10*Math.random():g>=90&&g<99?g+1*Math.random():g)},1e3);return{close:()=>{clearInterval(u),U(100),V(!1)}}},[]),W=h.useCallback(async()=>{await Ie("superResolution")||(z(!1),await Se("superResolution",he),z(!0)),V(!0);try{const u=Date.now();console.log("superResolution_start");const g=a.at(-1)??t,L=await Ft(g,U);if(!L)throw new Error("empty response");const C=new Image;C.dataset.id=Date.now().toString(),await _e(C,L),a.push(C),l.push({pts:[],src:""}),d([...a]),p([...l]),console.log("superResolution_processed",{duration:Date.now()-u})}catch(u){console.error("superResolution",u)}finally{V(!1)}},[t,l,o.naturalHeight,o.naturalWidth,a]);return i.jsxs("div",{className:["flex flex-col items-center h-full justify-between",Q?"animate-pulse-fast pointer-events-none":""].join(" "),children:[i.jsx("div",{ref:Y,style:{height:"116px"},className:["flex-shrink-0","mt-4 border p-3 rounded","flex items-left w-full max-w-4xl","space-y-0 flex-row space-x-5","scrollbar-thin scrollbar-thumb-black scrollbar-track-primary overflow-x-scroll"].join(" "),children:H}),i.jsx("div",{className:["flex-grow","flex justify-center","my-2","relative"].join(" "),style:{width:"70vw"},ref:se,children:i.jsxs("div",{className:"relative",children:[i.jsx("canvas",{className:"rounded-sm",style:y?{cursor:"none"}:{},ref:u=>{if(u&&!s){const g=u.getContext("2d");g&&m(g)}}}),i.jsxs("div",{className:["absolute top-0 right-0 pointer-events-none",x?"":"overflow-hidden"].join(" "),style:{width:x?`${s==null?void 0:s.canvas.width}px`:"0px",height:s==null?void 0:s.canvas.height,transitionProperty:"width, height",transitionTimingFunction:"cubic-bezier(0.4, 0, 0.2, 1)",transitionDuration:"300ms"},ref:u=>{u&&!ae&&de(u)},children:[i.jsxs("div",{className:["absolute top-0 right-0 pointer-events-none z-10",te?"bg-black text-white":"bg-primary ","w-1","flex items-center justify-center","separator"].join(" "),style:{left:`${ie}px`,height:s==null?void 0:s.canvas.height,transitionProperty:"width, height",transitionTimingFunction:"cubic-bezier(0.4, 0, 0.2, 1)",transitionDuration:"300ms"},children:[i.jsx("span",{className:"absolute left-1 bottom-0 p-1 bg-opacity-25 bg-black rounded text-white select-none",children:"original"}),i.jsx("div",{className:["absolute py-2 px-1 rounded-md pointer-events-auto",te?"bg-black":"bg-primary "].join(" "),style:{cursor:"ew-resize"},ref:u=>{u&&!S&&ue(u)},children:i.jsx(Pe,{className:"w-5 h-5",style:{cursor:"ew-resize"}})})]}),i.jsx("img",{className:"absolute right-0",src:o.src,alt:"original",width:`${s==null?void 0:s.canvas.width}px`,height:`${s==null?void 0:s.canvas.height}px`,style:{width:`${s==null?void 0:s.canvas.width}px`,height:`${s==null?void 0:s.canvas.height}px`,maxWidth:"none",clipPath:`inset(0 0 0 ${ie}px)`}})]}),Q&&i.jsx("div",{className:"z-10 bg-white absolute bg-opacity-80 top-0 left-0 right-0 bottom-0  h-full w-full flex justify-center items-center",children:i.jsxs("div",{ref:X,className:"text-xl space-y-5 w-4/5 sm:w-1/2",children:[i.jsx("p",{children:"正在处理中，请耐心等待。。。"}),i.jsx("p",{children:"It is being processed, please be patient..."}),i.jsx(je,{percent:ee})]})})]})}),!fe&&i.jsx(be,{children:i.jsxs("div",{className:"text-xl space-y-5",children:[i.jsx("p",{children:Et()}),i.jsx(je,{percent:ce})]})}),y&&i.jsx("div",{className:"fixed rounded-full bg-red-500 bg-opacity-50 pointer-events-none left-0 top-0",style:{width:`${M}px`,height:`${M}px`,transform:"translate3d(-100px, -100px, 0)"},ref:w}),i.jsxs("div",{className:["flex-shrink-0","bg-white rounded-md border border-gray-300 hover:border-gray-400 shadow-md hover:shadow-lg p-4 transition duration-200 ease-in-out","flex items-center w-full max-w-4xl py-6 mb-4, justify-between","flex-col space-y-2 sm:space-y-0 sm:flex-row sm:space-x-5"].join(" "),children:[a.length>0&&i.jsx(K,{primary:!0,onClick:T,icon:i.jsx("svg",{className:"w-6 h-6",width:"19",height:"9",viewBox:"0 0 19 9",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:i.jsx("path",{d:"M2 1C2 0.447715 1.55228 0 1 0C0.447715 0 0 0.447715 0 1H2ZM1 8H0V9H1V8ZM8 9C8.55228 9 9 8.55229 9 8C9 7.44771 8.55228 7 8 7V9ZM16.5963 7.42809C16.8327 7.92721 17.429 8.14016 17.9281 7.90374C18.4272 7.66731 18.6402 7.07103 18.4037 6.57191L16.5963 7.42809ZM16.9468 5.83205L17.8505 5.40396L16.9468 5.83205ZM0 1V8H2V1H0ZM1 9H8V7H1V9ZM1.66896 8.74329L6.66896 4.24329L5.33104 2.75671L0.331035 7.25671L1.66896 8.74329ZM16.043 6.26014L16.5963 7.42809L18.4037 6.57191L17.8505 5.40396L16.043 6.26014ZM6.65079 4.25926C9.67554 1.66661 14.3376 2.65979 16.043 6.26014L17.8505 5.40396C15.5805 0.61182 9.37523 -0.710131 5.34921 2.74074L6.65079 4.25926Z",fill:"currentColor"})}),children:bt()}),i.jsx(Wt,{label:wt(),min:10,max:200,value:n,onChange:G,onStart:B}),i.jsx(K,{primary:x,icon:i.jsx(ze,{className:"w-6 h-6"}),onUp:()=>{re(!x),setTimeout(()=>O(0),300)},children:xt()}),!x&&i.jsx(K,{onUp:W,children:vt()}),i.jsx(K,{primary:!0,icon:i.jsx(Ae,{className:"w-6 h-6"}),onClick:pe,children:yt()})]})]})}function Jt(){const[e,t]=h.useState(),[n,r]=h.useState("en");Fe(()=>r(R()));const[o,c]=h.useState(!1),a=h.useRef(null),[d,s]=h.useState(100);h.useEffect(()=>{Se("inpaint",s)},[]),Ue(a,()=>{c(!1)});async function m(f){const l=await fetch(`./examples/${f}.jpeg`).then(p=>p.blob());t(new File([l],`${f}.jpeg`,{type:"image/jpeg"}))}return i.jsxs("div",{className:"min-h-full flex flex-col",children:[i.jsxs("header",{className:"z-10 shadow flex flex-row items-center md:justify-between h-14",children:[i.jsx(K,{className:[e?"":"opacity-50 pointer-events-none","pl-1 pr-1 mx-1 sm:mx-5"].join(" "),icon:i.jsx(Oe,{className:"w-6 h-6"}),onClick:()=>{t(void 0)},children:i.jsx("div",{className:"md:w-[290px]",children:i.jsx("span",{className:"hidden sm:inline select-none",children:pt()})})}),i.jsx("div",{className:"text-4xl font-bold text-blue-600 hover:text-blue-700 transition duration-300 ease-in-out",children:"Inpaint-web"}),i.jsxs("div",{className:"hidden md:flex justify-end w-[300px] mx-1 sm:mx-5",children:[i.jsx(K,{className:"mr-5 flex",onClick:()=>{R()==="zh"?Re("en"):Re("zh")},children:i.jsx("p",{children:R()==="en"?"切换到中文":"en"})}),i.jsx(K,{className:"w-38 flex sm:visible",icon:i.jsx(He,{className:"w-6 h-6"}),onClick:()=>{c(!0)},children:i.jsx("p",{children:gt()})})]})]}),i.jsx("main",{style:{height:"calc(100vh - 56px)"},className:" relative",children:e?i.jsx(qt,{file:e}):i.jsx(i.Fragment,{children:i.jsxs("div",{className:"flex h-full flex-1 flex-col items-center justify-center overflow-hidden",children:[i.jsx("div",{className:"h-72 sm:w-1/2 max-w-5xl",children:i.jsx(It,{onSelection:async f=>{const{file:l}=await Xt(f,4096);t(l)}})}),i.jsxs("div",{className:"flex flex-col sm:flex-row pt-10 items-center justify-center cursor-pointer",children:[i.jsx("span",{className:"text-gray-500",children:ht()}),i.jsx("div",{className:"flex space-x-2 sm:space-x-4 px-4",children:["dog","car","bird","bag","jacket","shoe","paris"].map(f=>i.jsx("div",{onClick:()=>m(f),role:"button",onKeyDown:()=>m(f),tabIndex:-1,children:i.jsx("img",{className:"rounded-md hover:opacity-75 w-auto h-25",src:`./examples/${f}.jpeg`,alt:f,style:{height:"100px"}})},f))})]})]})})}),o&&i.jsx(be,{children:i.jsxs("div",{ref:a,className:"text-xl space-y-5",children:[i.jsxs("p",{children:[" ","任何问题到:"," ",i.jsx("a",{href:"https://github.com/lxfater/inpaint-web",style:{color:"blue"},rel:"noreferrer",target:"_blank",children:"Inpaint-web"})," ","反馈"]}),i.jsxs("p",{children:[" ","For any questions, please go to:"," ",i.jsx("a",{href:"https://github.com/lxfater/inpaint-web",style:{color:"blue"},rel:"noreferrer",target:"_blank",children:"Inpaint-web"})," ","to provide feedback."]})]})}),d!==100&&i.jsx(be,{children:i.jsxs("div",{className:"text-xl space-y-5",children:[i.jsx("p",{children:jt()}),i.jsx(je,{percent:d})]})})]})}Be.render(i.jsx(Jt,{}),document.getElementById("root"));
